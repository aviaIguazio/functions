kind: serving
metadata:
  name: sentiment-analysis-serving
  tag: ''
  hash: c127710a3b50ac08f34fc84da9a3f672bb055a82
  project: default
  labels:
    author: roye
    framework: pytorch
  categories:
  - serving
  - NLP
  - BERT
  - sentiment analysis
spec:
  command: ''
  args: []
  image: mlrun/ml-model
  description: BERT based sentiment classification model
  min_replicas: 1
  max_replicas: 4
  env: []
  base_spec:
    apiVersion: nuclio.io/v1
    kind: Function
    metadata:
      name: sentiment-analysis-serving
      labels: {}
      annotations:
        nuclio.io/generated_by: function generated from sentiment_analysis_serving.py
    spec:
      runtime: python:3.6
      handler: sentiment_analysis_serving:handler
      env: []
      volumes: []
      build:
        commands: []
        noBaseImagesPull: true
        functionSourceCode: aW1wb3J0IHRvcmNoCmltcG9ydCB0b3JjaC5ubiBhcyBubgpmcm9tIHRyYW5zZm9ybWVycyBpbXBvcnQgQmVydE1vZGVsLCBCZXJ0VG9rZW5pemVyCmltcG9ydCBtbHJ1bgpmcm9tIG1scnVuLnJ1bnRpbWVzIGltcG9ydCBudWNsaW9faW5pdF9ob29rCgpQUkVUUkFJTkVEX01PREVMID0gJ2JlcnQtYmFzZS1jYXNlZCcKdG9rZW5pemVyID0gQmVydFRva2VuaXplci5mcm9tX3ByZXRyYWluZWQoJ2JlcnQtYmFzZS1jYXNlZCcpCgoKY2xhc3MgQmVydFNlbnRpbWVudENsYXNzaWZpZXIobm4uTW9kdWxlKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBuX2NsYXNzZXMpOgogICAgICAgIHN1cGVyKEJlcnRTZW50aW1lbnRDbGFzc2lmaWVyLCBzZWxmKS5fX2luaXRfXygpCiAgICAgICAgc2VsZi5iZXJ0ID0gQmVydE1vZGVsLmZyb21fcHJldHJhaW5lZChQUkVUUkFJTkVEX01PREVMKQogICAgICAgIHNlbGYuZHJvcG91dCA9IG5uLkRyb3BvdXQocD0wLjIpCiAgICAgICAgc2VsZi5vdXRfbGluZWFyID0gbm4uTGluZWFyKHNlbGYuYmVydC5jb25maWcuaGlkZGVuX3NpemUsIG5fY2xhc3NlcykKICAgICAgICBzZWxmLnNvZnRtYXggPSBubi5Tb2Z0bWF4KGRpbT0xKQoKICAgIGRlZiBmb3J3YXJkKHNlbGYsIGlucHV0X2lkcywgYXR0ZW50aW9uX21hc2spOgogICAgICAgICIiIgoKICAgICAgICA6cGFyYW0gaW5wdXRfaWRzOgogICAgICAgIDpwYXJhbSBhdHRlbnRpb25fbWFzazoKICAgICAgICA6cmV0dXJuOgogICAgICAgICIiIgogICAgICAgIF8sIHBvb2xlZF9vdXQgPSBzZWxmLmJlcnQoCiAgICAgICAgICAgIGlucHV0X2lkcz1pbnB1dF9pZHMsCiAgICAgICAgICAgIGF0dGVudGlvbl9tYXNrPWF0dGVudGlvbl9tYXNrCiAgICAgICAgKQogICAgICAgIG91dCA9IHNlbGYuZHJvcG91dChwb29sZWRfb3V0KQogICAgICAgIG91dCA9IHNlbGYub3V0X2xpbmVhcihvdXQpCiAgICAgICAgcmV0dXJuIHNlbGYuc29mdG1heChvdXQpCgoKY2xhc3MgU2VudGltZW50Q2xhc3NpZmllclNlcnZpbmcobWxydW4uc2VydmluZy5WMk1vZGVsU2VydmVyKToKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLm1vZGVsID0gc2VsZi5sb2FkKCkKCiAgICBkZWYgbG9hZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBsb2FkIGJlcnQgbW9kZWwgaW50byBjbGFzcwoKICAgICAgICA6cmV0dXJuOiBtb2RlbAogICAgICAgICIiIgogICAgICAgIG1vZGVsX2ZpbGUsIF8gPSBzZWxmLmdldF9tb2RlbCgnLnB0JykKICAgICAgICBkZXZpY2UgPSB0b3JjaC5kZXZpY2UoJ2N1ZGE6MCcpIGlmIHRvcmNoLmN1ZGEuaXNfYXZhaWxhYmxlKCkgZWxzZSB0b3JjaC5kZXZpY2UoJ2NwdScpCiAgICAgICAgbW9kZWwgPSBCZXJ0U2VudGltZW50Q2xhc3NpZmllcihuX2NsYXNzZXM9MykKICAgICAgICBtb2RlbC5sb2FkX3N0YXRlX2RpY3QodG9yY2gubG9hZChtb2RlbF9maWxlLCBtYXBfbG9jYXRpb249ZGV2aWNlKSkKICAgICAgICBtb2RlbC5ldmFsKCkKICAgICAgICByZXR1cm4gbW9kZWwKCiAgICBkZWYgcHJlZGljdChzZWxmLCBib2R5KToKICAgICAgICAiIiIKICAgICAgICBwcmVkaWN0IGZ1bmN0aW9uCgogICAgICAgIDpwYXJhbSBib2R5OiBzZXQgb2YgaW5wdXRzIGZvciBiZXJ0IG1vZGVsIHRvIHByZWRpY3QgZnJvbQogICAgICAgIDpyZXR1cm46IGxpc3Qgb2Ygc2VudGltZW50IHByZWRpY3Rpb25zCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbnN0YW5jZXMgPSBib2R5WydpbnB1dHMnXQogICAgICAgICAgICBlbmMgPSB0b2tlbml6ZXIuYmF0Y2hfZW5jb2RlX3BsdXMoaW5zdGFuY2VzLCByZXR1cm5fdGVuc29ycz0ncHQnLCBwYWRfdG9fbWF4X2xlbmd0aD1UcnVlKQogICAgICAgICAgICBvdXRwdXRzID0gc2VsZi5tb2RlbChpbnB1dF9pZHM9ZW5jWydpbnB1dF9pZHMnXSwgYXR0ZW50aW9uX21hc2s9ZW5jWydhdHRlbnRpb25fbWFzayddKQogICAgICAgICAgICBfLCBwcmVkaWN0cyA9IHRvcmNoLm1heChvdXRwdXRzLCBkaW09MSkKICAgICAgICAgICAgcmV0dXJuIHByZWRpY3RzLmNwdSgpLnRvbGlzdCgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIkZhaWxlZCB0byBwcmVkaWN0ICVzIiAlIGUpCgoKZGVmIGluaXRfY29udGV4dChjb250ZXh0KToKICAgIG51Y2xpb19pbml0X2hvb2soY29udGV4dCwgZ2xvYmFscygpLCAnc2VydmluZ192MicpCgoKZGVmIGhhbmRsZXIoY29udGV4dCwgZXZlbnQpOgogICAgcmV0dXJuIGNvbnRleHQubWxydW5faGFuZGxlcihjb250ZXh0LCBldmVudCkKZnJvbSBtbHJ1bi5ydW50aW1lcyBpbXBvcnQgbnVjbGlvX2luaXRfaG9vawpkZWYgaW5pdF9jb250ZXh0KGNvbnRleHQpOgogICAgbnVjbGlvX2luaXRfaG9vayhjb250ZXh0LCBnbG9iYWxzKCksICdzZXJ2aW5nX3YyJykKCmRlZiBoYW5kbGVyKGNvbnRleHQsIGV2ZW50KToKICAgIHJldHVybiBjb250ZXh0Lm1scnVuX2hhbmRsZXIoY29udGV4dCwgZXZlbnQpCg==
  source: ''
  function_kind: serving_v2
  build:
    commands: []
    code_origin: http://github.com/aviaIguazio/functions.git#f566ab61f1380b0db3d5af8b043d7ba15c18b1fe:sentiment_analysis_serving.py
  secret_sources: []
  affinity: null
verbose: false
